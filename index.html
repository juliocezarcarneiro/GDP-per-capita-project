<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta http-equiv="X-UA-Compatible" content="ie=edge" />
  <title>Economic Indicators Analysis</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  <script src="https://d3js.org/d3.v7.min.js"></script>
  <style>
    body { background-color: #f8f9fa; font-family: 'Segoe UI', sans-serif; }
    .card { box-shadow: 0 4px 8px rgba(0,0,0,0.1); margin-bottom: 20px; border-radius: 10px; }
    .card-header { background-color: #0d6efd; color: white; border-radius: 10px 10px 0 0 !important; }
    .chart-container { height: 500px; margin-bottom: 20px; background: white; border-radius: 0 0 10px 10px; }
    .loading { display: flex; justify-content: center; align-items: center; height: 100%; }
    .filter-container { background: white; padding: 15px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
  </style>
</head>
<body>
  <div class="container">
    <div class="row mt-4">
      <div class="col-md-12 p-4 text-center bg-light rounded">
        <h2>Economic Indicators Analysis</h2>
        <p>Visualizing GDP, Health Spending and Income Inequality</p>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-12">
        <div class="filter-container">
          <div class="row">
            <div class="col-md-3">
              <label class="form-label">Year:</label>
              <select id="yearSelect" class="form-select">
                <!-- Populated by JS -->
              </select>
            </div>
            <div class="col-md-3">
              <label class="form-label">Map Metric:</label>
              <select id="metricSelect" class="form-select">
                <option value="GDP_per_capita">GDP per Capita</option>
                <option value="Health_spending_per_capita">Health Spending</option>
                <option value="GINI_index">Income Inequality (GINI)</option>
              </select>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-12">
        <div class="card">
          <div class="card-header">
            <h5>Global Indicators Map</h5>
          </div>
          <div id="geo-map" class="chart-container"><div class="loading">Loading map...</div></div>
        </div>
      </div>
    </div>

    <div class="row mt-3">
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>GDP vs Health Spending</h5>
          </div>
          <div id="bubble" class="chart-container"><div class="loading">Loading chart...</div></div>
        </div>
      </div>
      <div class="col-md-6">
        <div class="card">
          <div class="card-header">
            <h5>Top Health Spenders</h5>
          </div>
          <div id="bar" class="chart-container"><div class="loading">Loading chart...</div></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    function init() {
      d3.json("https://juliocezarcarneiro.github.io/test-repo/Resources/countries-data.json")
        .then(data => {
          if (!data || !Array.isArray(data)) throw new Error("Invalid data format");
          
          // Get available years and set default to most recent
          const years = [...new Set(data.map(d => d.Year))].filter(y => y).sort((a,b) => b-a);
          const yearSelect = document.getElementById("yearSelect");
          yearSelect.innerHTML = years.map(y => `<option value="${y}">${y}</option>`).join('');
          
          const updateCharts = () => {
            const year = +yearSelect.value;
            const metric = document.getElementById("metricSelect").value;
            updateAllCharts(data, year, metric);
          };
          
          yearSelect.addEventListener("change", updateCharts);
          document.getElementById("metricSelect").addEventListener("change", updateCharts);
          
          // Initial render
          updateCharts();
        })
        .catch(err => {
          document.querySelectorAll('.chart-container').forEach(el => {
            el.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
          });
        });
    }

    function updateAllCharts(data, year, metric) {
      const yearData = data.filter(d => d.Year === year);
      
      // Update map
      updateMap(yearData, metric);
      
      // Update bubble chart (always show all available data points)
      updateBubbleChart(yearData.filter(d => d.GDP_per_capita && d.Health_spending_per_capita));
      
      // Update bar chart (show all countries if less than 10, otherwise top 10)
      const healthSpenders = yearData
        .filter(d => d.Health_spending_per_capita)
        .sort((a,b) => b.Health_spending_per_capita - a.Health_spending_per_capita);
      updateBarChart(healthSpenders.slice(0, Math.max(3, healthSpenders.length)));
    }

    function updateMap(data, metric) {
      const container = document.getElementById("geo-map");
      
      const validData = data.filter(d => d[metric] !== undefined && d["Country Code"]);
      if (validData.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No data available for selected metric</div>';
        return;
      }

      const metricTitles = {
        GDP_per_capita: "GDP per Capita (USD)",
        Health_spending_per_capita: "Health Spending per Capita (USD)", 
        GINI_index: "GINI Index"
      };

      const trace = {
        type: 'choropleth',
        locationmode: 'ISO-3',
        locations: validData.map(d => d["Country Code"]),
        z: validData.map(d => d[metric]),
        text: validData.map(d => `${d["Country Name"]}: ${formatValue(metric, d[metric])}`),
        colorscale: getColorScale(metric),
        autocolorscale: false,
        reversescale: metric === 'GINI_index',
        colorbar: { title: metricTitles[metric] }
      };

      Plotly.newPlot(container, [trace], {
        title: `${metricTitles[metric]} by Country`,
        geo: { showframe: false, projection: { type: 'natural earth' } },
        margin: { t: 40, l: 0, r: 0, b: 0 }
      });
    }

    function updateBubbleChart(data) {
      const container = document.getElementById("bubble");
      
      if (data.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No GDP/Health spending data available</div>';
        return;
      }

      const trace = {
        x: data.map(d => d.GDP_per_capita),
        y: data.map(d => d.Health_spending_per_capita),
        text: data.map(d => `${d["Country Name"]}<br>GDP: $${formatNumber(d.GDP_per_capita)}<br>Health: $${formatNumber(d.Health_spending_per_capita)}`),
        mode: 'markers',
        marker: {
          size: data.map(d => Math.sqrt(d.Health_spending_per_capita) * 1.5),
          sizeref: 0.1,
          sizemode: 'area',
          opacity: 0.8
        }
      };

      Plotly.newPlot(container, [trace], {
        title: 'GDP vs Health Spending',
        xaxis: { title: 'GDP per Capita (USD)', type: 'log' },
        yaxis: { title: 'Health Spending per Capita (USD)', type: 'log' },
        hovermode: 'closest'
      });
    }

    function updateBarChart(data) {
      const container = document.getElementById("bar");
      
      if (data.length === 0) {
        container.innerHTML = '<div class="alert alert-warning">No health spending data available</div>';
        return;
      }

      const trace = {
        x: data.map(d => d["Country Name"]),
        y: data.map(d => d.Health_spending_per_capita),
        type: 'bar',
        text: data.map(d => `$${formatNumber(d.Health_spending_per_capita)}`),
        textposition: 'auto',
        marker: { color: '#1abc9c' }
      };

      Plotly.newPlot(container, [trace], {
        title: 'Health Spending per Capita',
        yaxis: { title: 'USD' },
        margin: { b: 100 }
      });
    }

    // Helper functions
    function formatNumber(num) {
      return num ? Math.round(num).toLocaleString() : 'N/A';
    }

    function formatValue(metric, value) {
      return metric === 'GINI_index' ? (value ? value.toFixed(1) : 'N/A') : `$${formatNumber(value)}`;
    }

    function getColorScale(metric) {
      return metric === 'GINI_index' ? [
        [0, '#4CAF50'], [0.3, '#8BC34A'], [0.5, '#FFC107'], 
        [0.7, '#FF9800'], [1, '#F44336']
      ] : [
        [0, '#E3F2FD'], [0.2, '#90CAF9'], [0.4, '#42A5F5'], 
        [0.6, '#1E88E5'], [0.8, '#1565C0'], [1, '#0D47A1']
      ];
    }

    document.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>